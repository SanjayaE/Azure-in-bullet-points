# Configure and manage virtual networks

- **Virtual Network (VNet)**
  - Communications and security boundary
    - Provides network isolation and segmentations
    - Enables Azure resources to communicate with each other securely
      - E.g. VM's, storage accounts, App Service apps, Azure SQL database instances
  - Uses Azure network backbone
    - Communications are internal by default unless you explicitly make it external
  - Name resolution
    - Azure-provided DNS
    - DNS service
  - Traffic filtering
    - NSGs
    - Network Virtual Appliances
  - ‚ùó 50-100 VNets allowed per subscription
  - ‚ùó A resource can only be created in a virtual network that exists in the same region and subscription as the resource.
  - **Why multiple VNets?**
    - Saving money
      - Service chaining: Share a network virtual appliance among several VNets
    - Segmenting workloads
      - NSGs and UDRs give you routing and traffic control
      - E.g. hub and spokes
    - Securing traffic
      - Private connectivity that uses the Microsoft backbone network
  - ***Allow External communication***
    - Internet 
       - All outbound access is allowed by default
       - All inbound traffic requires a public IP
    - Connect to on- permises
  - ***Filter and Route Traffic***
    - Network routes
    - Network Security Groups
    - Network Virtual Appliaces
    
  - ***Moving a VNet***
    - ‚ùó When moving a virtual network, you must also move its dependent resources
      - For VPN Gateways
        - You must move IP addresses, virtual network gateways, and all associated connection resources.
      - üí° Local network gateways can be in a different resource group.
    - To move a peered virtual network, you must first disable the virtual network peering
    - ‚ùó You can't move a virtual network to a different subscription if the virtual network contains a subnet with resource navigation links
      - For example, if an Azure Cache for Redis resource is deployed into a subnet, that subnet has a resource navigation link.

- **Role of VNet**
  - You can link app services, storage accounts, VM's
  - Provides traffic isolation and segmentation
  - Use a service endpoint to restrict access to a resource (e.g Azure storage) 
  - Runs on Azure backbone network
  - Configure communication with Internet
    - üí° Ensure only VMs that need public IP addresses get one.
  - You need to link VNets together to allow communication
  - Control traffic flows into the VNET, within the VNET, and between VNets.
  - Have IPv4 address space
    - Uses CIDR block of private RFC 1918 addresses that are not publicy/internet routable themselves
  - VNets are divided into subnets
    - E.g. in multi-tiered application, web-tier, business-tier, data-tier
      - Good for protecting access using NSGs
      - Sunets cant overlap
      - Good for having jumpbox and protecting who can connect to jump-box

- üí° **Azure VNet Design Best Practices**
  - Create subnets based on workloads
    - E.g. all of your web front-ends will have similar access requirements, then you can bind NSG's on subnet level.
  - Bind NSGs at the subnet level
    - Not good to bind at VNet level for better troubleshooting
  - Deploy a network virtual appliance (NVA) and user-defined routes (UDRs) to further customize traffic.
    - **Virtual appliance (NVA)**
      - E.g. enterprise grade firewall appliance, load balancer appliance
      - They exist in Azure marketplace
      - They'll be installed in VNet as a VM
    - **User defined routes (UDRs)**
      - Customize and control routing in a VNet
  - Implement site-to-site or point-to-site VPN tunnels with on-premises environment

- **Deploy a VNet**
  - You can use ARM templates e.g. from Github.
    - Visual Studio is recommended for editing templates
  - During deployment:
    - *Name*: Must be unique
    - *Subnet*: Default gives you one subnet, for more you can use ARM template or PowerShell/CLI
    - *DDoS protection*
      - Microsoft publishes their datacenter public IP address
      - Bad actors run port-scanners on those IP addresses all the time
    - *Service endpoints*
      - Allows you to integrate Azure PaaS services
  - After deployment:
    - *Address space*
      - You cannot edit
      - You need to create new and delete old one.
    - *Subnets*
      - You can always add new subnets & deploy gateway subnet that'll be used by an Azure gateway.
      - In CIDR Azure reserves 5 addresses and  /29 is the smallest
    - *DNS server*
      - Default is azure provided
      - You can use custom by additional DNS servers
        - Affect all VMs
        - Still uses Azure DNS when necessary
        - Used when e.g. site-to-site or point-to-site connections, it'll affect all VMs.
    - *Diagram*
      - You can enable network watcher here.
      - You then load in subscription or RG and enable.
      - It shows topology

- **Network Security Groups**
  - Stateful firewall for inbound and outbound traffic
    - Stateful = 5-tuple hash
      - Source + destination IP and ports
      - Protocol
  - Has default rules
  - Augmented rules
    - Allow you specify list of IP-addresses
    - No need to create several rules for same list
  - **Service tags**
    - Azure defined named IP address endpoints
    - E.g. *Internet*, *VirtualNetwork*, *AzureLoadBalancer*, *AzureTrafficManager*, *Storage*, *SQL*, *AzureCosmosDB*, *AzureKeyVault*.
    - Allows you to use names instead of IP addresses
  - **Application Security Groups (ASGs)**
    - Custom (user-defined) logical identifiers
    - You can associate IP ranges and then use it as source/destination in NSG's.
    - E.g. *WebServer*, *WappServers*, *DbServers*
  - Can be bound to VNets, subnets or NICs
    - üí° Bind to subnets
  - Security rules
    - Priority: Lower the number, higher the priority of the rules
- **Public IPs**

  - Two types of Public IP SKUs
    - Basic SKU - Static/Dynamic, Open by default, Restrict traffic using NSGs, Do not support availability zones
    - Standard SKU - Static, Closed to inbound traffic, whitelist traffic using NSGs, Zone redundant
  - Public IP Assignments
    - Virtual Machines - assigned to the primary NIC
    - VPN Gateways - Only Dnynamic supported
    - Appliction Gateways 
    - Internet facing Load Balancers
    
  - Two types of Public IPs
    - Dynamic - Default, Not assigned when VM created, assigned during startup and released when VM restarted/stopped/ deallocated
    - Static - When VM is provisioned, never released (unless delete the resource/ changed to dynamic), assigned from Azure resource pool
    
- **Private IPs**
 - VMs within the VNet 
 - Can use to connet to an on -perm env using
    - VPN Gateway 
    - ExpressRoute
 - Not accessible to the Internet
 
  - Private IP Assignments
    - VMs (each NIC is assigned a private IP)
    - Internal Load Balancers
    - Application Gateways
   - Types of Private IPS are similar to public (static/dynamic) with characteristics, but you never set the static IP
   - Private Static Ip uses - Domain controllers / DNS servers
    
- üí° **IP Addressing Best Practices**    
  - If a VM doesn't need a public IP address (PIP), then don't assign one and use an Azure load balancer instead.
  - Not recommend to apply static IPs to the OS of VM (exceptions- assigning multiple IPs to a VM / Use same iP as NI
  - Plan your VNet private address space to avoid overlap.
    - Different from on-premises
    - Different from other VNets in Azure
  - Never configure networking from within the VM
    - Do it on Azure instead using Azure abstractions

- **Network interfaces**
  - Assigned to a single subnet.
  - Have a public or private IP that's dynamic or static.
  - *IP forwarding*
    - E.g. if you have network appliance and you want to give it ability to forwar traffic that's not destined for itself

- **Connecting VNets**
  - You don't need to have a Layer 3 router to route traffic from subnet to subnet
  - Azure system routes take care of the routing for you automatically
  - **VPN gateway**
    - Creates IPsec/IKEv2 tunnel and always-on connection
    - Used for connecting VPN's in cloud or hybrid scenario.
  - Options:
    - **VNet-to-VNet VPN**
      - Create isolation or administrative boundaries
      - Provide cross-region geo-redundancy and replication securely
      - No traffic crosses the public internet
      - Separate VPN gateways costs while VNet peering is free.
      - üí° Make sure your VNet address spaces do not overlap.
      - Troubleshooting
        - Verify connectivity through peering
          - Set up Azure DNS

    - **VNet peering**
      - ‚ùó Seamless connection between two Azure VNets.
        - The peered networks appear as one, for connectivity purposes.
        - Name resolution does not flow, requires own DNS zone
      - Runs on Azure backbone
      - üí° You can peer across regions and subscriptions
      - Peering can overcome misplaced VMs
      - Save money with service chaining (e.g. services' communication are chained through a subnet)
      - ‚ùó Peering must be done on both sites
        - VNet1 <=> VNet2 and VNet2 <=> VNet1
      - ***Configuration***
        - **Allow forwarded traffic**
          - Am I peering from a hub VNet that'll have IP-forwarder?
          - Allow peers (other VNets) to forward traffic to go through.
        - **Allow gateway transit**
          - Am I hosting a VPN gateway?
        - **Use remote gateways**
          - Is this network use peers gateway?
          - ‚ùó VNets must be in same region
      - Enables **force tunnelling**
        - E.g. when all Internet traffic must go through on-premises firewall device.
        - You can use *user defined routes* for all outbound traffic to go back through VPN gateway to on-premises.
      - ‚ùó Peerings are not transitive
        - If you peer spoke1 <=> spoke2 and spoke2 <=> spoke3 then spoke1 cannot communicate with spoke3 automatically.
        - Common solution is transiting VNet with **Hub and Spoke topology**.
          - Topology is a segmentation
            - **When to segment with VNets and when with subnets?**
              - Depends on bureaucratic reasons
              - E.g. different VNets when
                - Different cost centers/groups need management autonomy
                - You want to completely isolate different workloads
          - Name resolution needs configurations
            - You can't do with Azure provided DNS as all your hosts have then `internal.cloudapp.net`
            - In peering azure provided DNS won't work
      - ***Troubleshooting tips***
        - Azure blocks ICMP between Vnets and the Internet
          - ICMP is used for ping
          - Microsoft blocks it because of DDoS attacks.
        - Simplify NSGs as much as possible to reduce troubleshooting friction
        - Azure portal Diagnose and solve problems/Resource health blade is useful
        - Network Watcher and Network Permormance Monitor make troubleshooting much easier
          - **Network Watcher**
            - Shows where's the traffic is captured/denied
            - Suite of tools
              - **Topology**: e.g. VNet's, subnets, VM's, NIC's
              - **Variable Packet Capture**: Captures TCP packages at NIC level as wireshark files.
              - **IP Flow Verify**: Troubleshoots NSG
              - **Next hop**: Troubleshoots route tables
              - **Connection troubleshoot**: Why it does not connect?
              - Diagnostics Logging
              - Security Group View
              - NSG Flow Logging
              - VPN Gateway Troubleshooting
              - Network Subscription Limits
              - Role Based Access Control
            - In Portal you can search for Network Watcher and enable it on VM's
          - **Network Performance Monitor**
            - E.g. top network health events, expressroute monitor, service endpoint monitor, performance monitor
            - It ties in logs/metrics with Log Analytics.
            - Part of Insights & Analytics Azure management solution.
            - Works with installing Microsoft Monitoring Agent (MMA) in VM.
            - ***Flow***
              1. Deploy Insight & Analytics and then select Network Performance Monitor
              2. Choose VM and click on "Connect", it'll install `MicrosoftMonitoringAgent`
    - **Hybrid Connection**
      - **Site-to-site VPN**
        - Two VPN devices connect to each other.
        - ***Flow***
          1. Deploy a ***VPN Gateway*** resource in Azure
              - Requires gateway subnet (or DMZ subnet).
              - Different SKUs: Basic, VpnGw1, VpnGw2, VpnGw3
                - You get more bandwith, site-to-site and point-to-site points.
                - Don't use basic for production
              - You can see the deployed VPN Gateway in *Connected Devices* in subnet.
          2. Deploy a ***Local Network Gateway*** as well.
              - For your on-prem gateway device, you need to set up one of the route table configurations:
                - **PolicyBased**
                  - Handle route tables manually
                  - ‚ùó Does not work with BGP failover, active-to-active configurations
                - **RouteBased**
                  - üí° Always use if possible
                    - Some VPN devices do not support it
                    - What's compatible is documented on Microsoft docs.
          3. Create a connection between two gateways
              - Create local-to-azure in Local Network Gateway
              - Create azure-to-local in VPN Gateway
              - In Shared Key in connection blade, specify a key.
      - **Point-to-site VPN**
        - ALlows access to Azure resources through VPN tunnel from a client agent.
          - More portable way
          - ***Flow***
            1. On Azure deploy VPN gateway
            2. In Point-to-site configuration blade download VPN client
            3. Deploy agent (a VPN Client) from VPN gateway
            4. Install on individual endpoints (e.g. laptops)
          - Allows connection outside network perimeter
      - **Express route**
        - High speed secure connection between on-prem and cloud
      - **Highly Available Hybrid Cloud**
        - ***Combine ExpressRoute and VPN***
          - In gateway subnet
            - Deploy ExpressRoute gateway
            - Deploy VPN Gateway
          - Both gateways gives access to front-end tier and a jumpbox in a management subnet
          - If ExpressRoute goes down VPN gateway gets activated
        - ***Deploy two VPN's***
          - Requires enabling BGP in gateway link
            - Robust routing
            - Enable active-to-active connection configuration
            - ‚ùó Only allowed RouteBased routing configuration
          - Two VPN gateways on-prem
          - Two VPN gateways on-prem
          - Allows redundant active-to-active connection to single gateway.
            - You have one active and one stand-by gateway
  - **System Routes vs. User-defined Routes**
    - ***Situations***
      - You need to move one VM to another VNet.
        - It requires re-deploying
      - Isolation & segmentations
        - E.g. development / production VNet
      - ***Hub & Spoke Topology***
        - *Hub*: VNet have Virtual Network Appliance (e.g. firewall), or gateway
          - You don't want to have *Virtual Network Appliance* as it costs both money and resources.
        - *Spokes*
          - Other VNets (e.g. front-end, back-end)
          - You can force communicates with each other through Hub.
    - Internet calls and calls from internet
      - Handled by Azure using system routes
      - You don't need to manipulate them
    - If you want to override system routes (e.g. for Hub & Spoke topology)
      - You need User Defined Routing
      - For network appliance you need to configure IP forwarding
        - Enables it to pass on traffic that it's not destined for itself.

- **Name Resolution**
  - **Azure-provided name resolution**
    - No configuration required
    - All VMs within a VNet can resolve each others' host names
    - ‚ùó Limitations:
      - Cross-VNet name resolution
      - Issue: No custom DNS suffix
    - You can add custom DNS server IP addresses
      - E.g. in hybrid cloud if you want Azure VM's to have IP addresses from on-premises DNS server or vice versa.
      - E.g. stand up own DNS servers in VNet instead.
      - E.g. configure DNS forwarding between one DNS server in one VNet to another DNS server in another VNet
  - **Azure DNS**
    - Allows VNet's to resolve each others host names.
    - ***Host your public DNS domain in Azure***
      - Use Azure geo-distributed name servers for high speed name resolution
      - Delegate a domain:
        1. Create a DNS Zone
        2. Copy an Azure DNS name server from the zone
        3. In the registrar's DNS management page, edit the NS records and replace the NS records with the Azure DNS name servers.
    - You manage in Portal -> DNS zone
      - Each DNS zone has
        - VNets of associated with it
        - **Record-sets**: IP addresses and host names of VM's
    - ***Create private DNS zones***
      - Allows you to not route names in public DNS
      - ***Linked to VNets***
        - Lets you avoid setting up own DNS infrastructure
      - ***Registration VNet***
        - You create private DNS zone and registration VNet
        - Any VMs within that VNet will automatically have their names registered and DNS records created in Azure DNS
      - ***Resolution VNet***
        - Allows you to have name resolution across VNets
        - Other VNets will be resolution VNets
        - Allows you to create records (hosts, alias) for VM's and it'll support name resolution across VNets
  - **DNS Name Resolution in Hybrid Cloud**
    - Azure provided DNS won't work with peering.
    - A potential solution
      - On-prem: Configure own DNS server and configure forward queries to Azure.
      - In Azure
        - Connect VNets (peer or VPN)
        - Deploy own DNS servers in VNets and configure forwarding there
      - ‚ùó Too much overhead
    - üí° Use **Azure DNS Private Zones** instead
      - Configure Azure DNS servers specifically for private zones.
      - One network: Registration network
        - Hosts will have their names auto-registered in private zones.
      - Other networks: Resolution networks
        - You need to manually create hosts in CNAME/MX records.
      - ***Set-up DNS name for peered Virtual Appliance and a VNet in a Hub & Spoke topology ***
        - Existing VM's
          - [Host (spoke) VM] in [Host (spoke) VNet]
          - [Hub (virtual appliance, hybrid)] VM in [Hub (virtual appliance, hybrid) VNet]
        1. ***Create & set-up route table***
            1. Create a route table -> Routes -> Add ->
                - *Name*: E.g. *subnet1-nva*
                - *Address prefix*: If destination IP of a packet matches this then it matches the rules. E.g. *192.168.8.0/24*
                - *Next hop type*: Virtual network gateway, virtual network, internet, virtual appliance, none.
                  - Choose [Hub (virtual appliance, hybrid) VM]
                - Set next-hop address to IP of [Hub (virtual appliance, hybrid) VM]
            2. Associate route table to related subnets
                - Route-table -> Subnets -> Associate subnet
        2. **Set-up peering**
            - You can ping to VNets as name resolution does not work across VNets
            - Set-up without any *allow forwarded traffic*, *allow gateway transit*, *use remote gateways* configuration
              - [Hub (virtual appliance, hybrid) VNet] <=> [Host (spoke) VNet]
        3. **Create DNS Zone**
            - In portal -> DNS zone -> Add DNS zone
            - Create private DNS zone in VA (hybrid) VNet
            - Create DNS zone
              - Register record set with IP and name of each VM
              - Register two VNets
                - Registration VNET for [Hub (virtual appliance, hybrid) VM]
                - Resolution VNET for [Host (spoke) VM]
